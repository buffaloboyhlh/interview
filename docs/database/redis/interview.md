# Redis 面试题整理 

[Redis综述篇](https://juejin.cn/post/7097521572885299214)


[56道Redis八股文](https://javabetter.cn/sidebar/sanfene/redis.html)


[最全的 116 道 Redis 面试题解答](https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/%E6%9C%80%E5%85%A8%E7%9A%84%20116%20%E9%81%93%20Redis%20%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E7%AD%94.md)

# Redis 工作中遇到的问题

在实际工作中使用 Redis 时，常常会遇到各种问题，这些问题可能会影响系统的性能、可用性和数据的一致性。以下是几个常见的 Redis 问题的具体案例和详细解析：

### 1. **缓存穿透**

#### 案例：
某电商平台的用户经常查询不存在的商品 ID，导致大量请求直接穿透缓存访问数据库，造成数据库压力过大。

#### 问题分析：
缓存穿透是指用户查询的数据既不在缓存中也不在数据库中，导致每次查询都直接访问数据库，缓存无法发挥作用。如果黑客恶意请求大量不存在的数据，可能造成数据库压力骤增。

#### 解决方案：
- **缓存空值**：对查询结果为空的数据进行缓存，设置一个短时间的过期时间，避免反复查询同一个不存在的数据。
- **布隆过滤器**：在缓存层之前添加布隆过滤器，用于快速判断请求的 key 是否存在。布隆过滤器能够有效地拦截不存在的 key，从而减少对数据库的访问。

### 2. **缓存雪崩**

#### 案例：
在某网站的促销活动期间，用户访问量激增，缓存中的数据大量过期，导致所有请求直接打到数据库，数据库负载过高，系统出现卡顿。

#### 问题分析：
缓存雪崩是指缓存中的大量数据在某个时刻集中失效，导致大量请求直接访问数据库。此时，数据库压力急剧增加，可能导致系统无法正常响应。

#### 解决方案：
- **设置过期时间的随机化**：在设置缓存过期时间时，加上一个随机值，避免大量缓存同时失效。
- **多级缓存**：在本地或中间层设置一级缓存，将压力分散到多级缓存中，减少对数据库的直接访问。
- **缓存预热**：在系统启动时或活动开始前，提前加载热点数据到缓存中，防止在高峰时段突然失效。

### 3. **缓存击穿**

#### 案例：
某社交平台上的热点帖子突然被大量用户访问，导致该帖子的缓存失效，大量请求直接打到数据库，数据库瞬时压力过大。

#### 问题分析：
缓存击穿是指一个热点数据在缓存失效后，大量请求同时到达缓存，因缓存失效导致请求直接打到数据库，瞬间的高并发请求可能会压垮数据库。

#### 解决方案：
- **设置互斥锁**：在缓存失效时，使用分布式锁机制控制只有一个请求能更新缓存，其余请求等待，避免同一时刻大量请求打到数据库。
- **使用持久缓存**：对于热点数据，可以设置为永不过期或设置较长的过期时间，结合后台定期更新缓存，确保热点数据的缓存持续可用。

### 4. **内存溢出**

#### 案例：
某游戏应用使用 Redis 存储用户的会话数据和游戏状态，随着用户数量的增加，Redis 内存占用不断增长，最终导致 Redis 频繁触发内存淘汰，甚至出现内存溢出问题。

#### 问题分析：
Redis 是一个内存数据库，所有的数据都存储在内存中。如果存储的数据量过大，超过了服务器的内存上限，Redis 就会开始淘汰旧数据，可能会导致关键数据丢失。如果内存不足而数据量持续增加，可能会导致 Redis 崩溃。

#### 解决方案：
- **设置内存上限**：通过配置 `maxmemory` 参数，限制 Redis 使用的最大内存，避免内存溢出。
- **选择合适的淘汰策略**：根据业务需求选择合适的内存淘汰策略，例如 LRU（最近最少使用）或 LFU（最不常使用）等，确保重要数据不会被淘汰。
- **优化数据结构和压缩**：优化 Redis 存储的数据结构，尽量使用更紧凑的数据结构来减少内存占用。例如，使用 `hash` 存储对象属性，避免存储冗余数据。

### 5. **数据不一致**

#### 案例：
在一个电商系统中，订单状态信息被存储在 Redis 中，而订单的详细信息存储在 MySQL 中。某次订单状态更新后，Redis 和 MySQL 中的数据出现不一致，导致用户看到错误的订单状态。

#### 问题分析：
在 Redis 和 MySQL 双写的场景下，可能由于网络延迟或系统故障导致 Redis 和 MySQL 的数据更新不同步，从而产生数据不一致的问题。例如，订单状态首先更新到 MySQL，但由于网络问题，更新操作未及时同步到 Redis。

#### 解决方案：
- **使用分布式事务**：使用分布式事务或二阶段提交，确保 Redis 和 MySQL 的数据更新保持一致。
- **延迟双删策略**：在更新数据库后，先删除 Redis 中的缓存数据，然后延迟一段时间再次删除缓存，确保数据一致。
- **使用一致性哈希**：在缓存更新时，使用一致性哈希算法保证缓存和数据库的版本号同步，确保数据一致。

### 6. **主从复制延迟**

#### 案例：
某大型电商网站的 Redis 集群在高并发写入的情况下，从库的数据更新延迟较大，导致用户在从库读取数据时看到的数据不一致。

#### 问题分析：
Redis 的主从复制是异步的，因此在主库写入大量数据时，从库可能无法及时同步这些更新，导致数据延迟。这在需要高实时性的场景中可能会引起用户体验问题。

#### 解决方案：
- **使用半同步复制**：通过配置 Redis 的 `min-slaves-to-write` 和 `min-slaves-max-lag` 参数，确保主库在数据写入时等待至少一个从库确认，减少数据延迟。
- **读写分离策略**：合理规划读写分离的策略，将高实时性的读操作尽量安排在主库进行，而非从库。
- **优化写操作**：减少大批量写操作，或将写操作分散到多个时间点，减少对主从复制延迟的影响。

### 7. **持久化问题**

#### 案例：
某金融系统使用 Redis 作为主要的数据存储工具之一，但在某次系统宕机后，发现部分数据丢失，影响了业务的连续性。

#### 问题分析：
Redis 支持 RDB 和 AOF 两种持久化方式，但如果持久化配置不当或频率设置过低，可能会导致数据丢失问题。RDB 生成快照的间隔较长时，宕机可能导致丢失大量数据；而 AOF 如果未开启或策略不合理，可能导致数据无法完全恢复。

#### 解决方案：
- **启用 AOF 持久化**：配置 Redis 使用 AOF 持久化，并将策略设置为 `always`，确保每次写操作都会被持久化。
- **定期备份**：定期备份 Redis 的 RDB 文件和 AOF 文件，确保在系统故障时能够恢复数据。
- **启用主从复制**：通过 Redis 主从复制，确保数据在多个节点上存在，避免单点故障带来的数据丢失风险。

这些案例和解决方案展示了在使用 Redis 时可能遇到的一些典型问题。通过合理的配置、优化和监控，可以有效预防和解决这些问题，确保 Redis 系统的稳定性和高效性。